<!DOCTYPE html>
<html>
  <head>
	<meta charset="utf-8">
	<title>Robot control</title>
	<style type="text/css">
            body {
                    background-color: white;
                 }
	    #control {
        	 margin-left: 60px;
		 width: 200px;	
		 display:inline-block;
         	}
	    #camera {
                 margin-left: 0px;
		 width: 200px;
		 display:inline-block;
                }
	    #front {
                margin: 2px 46px;
                }
	    #brake {
                margin: 2px 40px;
                }
	    #webcam {
                 margin-top: 10px;
                 margin-left: 500px;
		 width: 500px;
                }
	    #up {
         	margin: 2px 26px;
         	}
	    #down {
                margin: 2px 20px;
                }
	    .parent {
	     	 position: relative;
 	 	 top: 70px;
  		 left: 50px;
		 width: 300px;
		}
	    #image1 {
  		position: relative;
  		top: 0;
 	 	left: 0;
		width: 300px;
		}
	    #image2 {
  		position: absolute;
  		top: 0px;
 	 	left: 0px;
		width: 300px;
		}
	    #image3 {
  		position: absolute;
  		top: 0px;
  		left: 0px;
		width: 300px;
        	}
	    #image4 {
  		position: absolute;
 		top: 0px;
  		left: 0px;
		width: 300px;
        	}
        </style>
 </head>
  <body>
	<div id="control">
	   <h3>Control</h3>
	   <p> <button id="front" onclick="vpred()">W↑</button> </p>
	   <p> <button id="left" onclick="leva()">A<-</button> 
	       <button id="back" onclick="vzad()">S↓</button>         
	       <button  id="right" onclick="prava()">D-></button>
	   <p><button id="brake" onclick="brzda()">Brake</button> </p>

	</div>
	 <div id="camera">
           <h3>Camera</h3>
           <p> <button id="up" onclick="nahoru()">up</button> </p>
           <p> <button id="left" onclick="doleva()">left</button>
               <button id="right" onclick="doprava()">right</button>
           </p>
	    <p><button id="down" onclick="dolu()">down</button> </p>
        </div>
	 <div id="webcam"><noscript><img src="./?action=snapshot" /></noscript></div>
	<div class="parent">
  	  <img id="image1" src="img/horizon_back.svg" />
  	  <img id="image2" src="img/horizon_ball.svg" />
  	  <img id="image3" src="img/horizon_circle.svg" />
  	  <img id="image4" src="img/horizon_mechanics.svg" />
	</div>

     <body onload="createImageLayer();">

    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
      var socket = io();

      socket.on("data", function(data){
        datas=String.fromCharCode.apply(null, new Uint8Array(data));
        var dataArray = datas.split(" ");
        roll(Number(dataArray[3]));
	pitch(Number(dataArray[2]));
	});

      function pitch(angle) {
	 var img2 = document.getElementById('image2');
	 img2.style.top =  angle*0.7 + '%';
	}

      function roll(angle) {
	angle=angle + 6;
	 var img1 = document.getElementById('image1');
         var img2 = document.getElementById('image2');
         var img3 = document.getElementById('image3');
        img1.style.transform = 'rotate(' + angle + 'deg)';
        img2.style.transform = 'rotate(' + angle + 'deg)';
        img3.style.transform = 'rotate(' + angle + 'deg)';
	}
       function nahoru() {
           socket.emit("pohyb", "i");
        }
      function dolu() {
           socket.emit("pohyb", "k");
        }
      function doleva() {
           socket.emit("pohyb", "n");
        }

      function doprava() {
           socket.emit("pohyb", "m");
        }
      function brzda() {
           socket.emit("pohyb", "b");
        }
      function vpred() {	 
           socket.emit("pohyb", "w");
        }
      function vzad() {
           socket.emit("pohyb", "s");
        }
      function leva() {
           socket.emit("pohyb", "a");
        }
      function prava() {
           socket.emit("pohyb", "d");
        }
	var front = false,
    	right = false,
    	back = false,
    	left = false
	document.addEventListener('keydown',press)
	function press(e){
  	if (e.keyCode === 87 && front===false){
		socket.emit("pohyb", "w");
    		front = true;
  	}
  	if (e.keyCode === 68 /* d */&& right===false){
		socket.emit("pohyb", "d");
    		right = true;
  	}
  	if (e.keyCode === 83 /* s */&&back===false){
    		socket.emit("pohyb", "s");
		back = true;
  	}
  	if (e.keyCode === 65 /* a */&&left===false){
    		socket.emit("pohyb", "a");
		left = true;
  	}
	}
	document.addEventListener('keyup',release)
        function release(e){
        if (e.keyCode === 87 /* w */){
                socket.emit("pohyb", "b");
		front = false;
        }
        if (e.keyCode === 68 /* d */){
		socket.emit("pohyb", "b");
                right = false;
        }
        if (e.keyCode === 83 /* s */){
		socket.emit("pohyb", "b");
                back = false;
        }
        if (e.keyCode === 65 /* a */){
		socket.emit("pohyb", "b");
                left = false;
        }
        }
	var imageNr = 0;
	var finished = new Array(); 

	function createImageLayer() {
  		var img = new Image();
  		img.style.position = "absolute";
  		img.style.zIndex = -1;
  		img.onload = imageOnload;
		//192.168.7.2 for usb, 10.1.1.100 ethernet (static IP)
  		img.src = "http://192.168.7.2:8090/?action=snapshot&n=" + (++imageNr);
  		var webcam = document.getElementById("webcam");
  		webcam.insertBefore(img, webcam.firstChild);
	}

	function imageOnload() {
  		//this.style.zIndex = imageNr;
  	    while (1 < finished.length) {
    		var del = finished.shift();
    		del.parentNode.removeChild(del);
  	    }
  		finished.push(this);
		createImageLayer();
	}
    </script>	
</body>
</html>
